#!/usr/bin/env python3

#HALP Merge master into all PRs and carrion.

from common import findproject, githubuser, nicely, allbranches, ispublic, stderr, pb, run
import os

def main():
    os.chdir(findproject()) # XXX: Why?
    prefix = "%s-" % githubuser()
    # FIXME: Do things in dependency graph order, in particular for kitchen-sink.
    def mergethem():
        for b in allbranches():
            run(['git', 'checkout', b])
            public = ispublic()
            if public and not b.startswith(prefix):
                stderr("Skip: %s" % b)
            elif public or b == 'kitchen-sink' or b.startswith('controversial-'):
                run(['git', 'merge', '--no-edit', pb()])
            else:
                run(['git', 'rebase', pb()])
    nicely(mergethem)

if '__main__' == __name__:
    main()
