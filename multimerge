#!/usr/bin/env python3

#HALP Merge master into all PRs and carrion.

from common import findproject, githubuser, nicely, allbranches, ispublic, stderr, pb, run
import os

def mergethem():
    remaining = allbranches()
    parents = {b: pb(b) for b in remaining}
    prefix = "%s-" % githubuser()
    def update(b):
        run(['git', 'checkout', b])
        if ispublic() or b == 'kitchen-sink' or b.startswith('controversial-'):
            run(['git', 'merge', '--no-edit', pb()]) # TODO: Generalise logic.
        else:
            run(['git', 'rebase', pb()])
    done = set()
    while remaining:
        stderr("Remaining: %s" % ' '.join(remaining))
        def g():
            for b in remaining:
                p = parents[b]
                if p.startswith('origin/') or p in done:
                    update(b)
                    done.add(b)
                else:
                    yield b
        remaining = list(g())

def main():
    os.chdir(findproject()) # XXX: Why?
    nicely(mergethem)

if '__main__' == __name__:
    main()
