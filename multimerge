#!/usr/bin/env python3

#HALP Merge master into all PRs and carrion.

from common import findproject, nicely, allbranches, ispublic, stderr, parents, run
import os

def mergethem():
    remaining = allbranches()
    branchtoparents = {b: parents(remaining, b) for b in remaining}
    allparents = set(p for parents in branchtoparents.values() for p in parents)
    def update(b, p):
        run(['git', 'checkout', b])
        if b in allparents or ispublic():
            run(['git', 'merge', '--no-edit', p])
        else:
            run(['git', 'rebase', p])
    done = set()
    while remaining:
        stderr("Remaining: %s" % ' '.join(remaining))
        def g():
            for b in remaining:
                p = branchtoparents[b][0]
                if p.startswith('origin/') or p in done:
                    update(b, p)
                    done.add(b)
                else:
                    yield b
        remaining = list(g())

def main():
    os.chdir(findproject()) # XXX: Why?
    nicely(mergethem)

if '__main__' == __name__:
    main()
